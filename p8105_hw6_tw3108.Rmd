---
title: "p8105_tw3108_hw6"
author: "Tao Wu"
date: "2025-12-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,warning=FALSE,message=FALSE}
library(tidyverse)
library(broom)
library(readr)
library(ggplot2)
data <- read_csv("data/homicide-data.csv")
new = data %>% 
  mutate(
   city_state = str_c(city, state, sep = ", "),
   check = if_else(disposition == "Closed by arrest", 1, 0),
   victim_age = as.numeric(victim_age)
  ) %>% 
  filter(!city_state %in% c("Dallas, TX","Phoenix, AZ","Kansas City, MO","Tulsa, AL")
  ) %>% 
  filter(victim_race %in% c("White", "Black"))
baltimore = new %>% 
  filter(city_state == "Baltimore, MD")
model = glm(check ~ victim_age + victim_sex + victim_race, data = baltimore, family = binomial()
 )
tidymodel = broom::tidy(model)
or = tidymodel %>%
  filter(term == "victim_sexMale") %>%
  mutate(
    or = exp(estimate),
    conf.low = exp(estimate - 1.96 * std.error),
    conf.high= exp(estimate + 1.96 * std.error)
  ) %>%
  select(term, or, conf.low, conf.high)
or
cityor = new %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(
    model = map(data, ~ glm( check ~ victim_age + victim_sex + victim_race, data = .x, family = binomial()
  )
  ),
    result = map(model, ~ broom::tidy(.x))
  ) %>% 
  unnest(result) %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(
    or       = exp(estimate),
    conf.low = exp(estimate - 1.96 * std.error),
    conf.high= exp(estimate + 1.96 * std.error)
  ) %>% 
  select(city_state, or, conf.low, conf.high) %>% 
  ungroup()
cityor
cityplot = cityor %>% 
  ggplot(aes(x = or, y = reorder(city_state, or))) +
  geom_point() +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high)) +
  labs(
    x = "or for homocide",
    y = "City & State",
    title = "adjusted or"
  )
cityplot
```
Problem1: 
In most cities, the or is close to 1, indicating that in most cases the clearance rate for male victims is similar to female victims.
A few cities show higher or estimates, but with much wide CI, suggesting that these cities have small sample sizes or limited number of clearances. Overall, there is not enough evidence in most cities to show a significant difference in clearance rates between male and female victims.
```{r, message=FALSE,warning=FALSE}
library(p8105.datasets)
library(tidyverse)
library(modelr)
library(broom)
data("weather_df")
set.seed(1234)
boot = weather_df %>%
  modelr::bootstrap(n = 5000)
  model1 = boot %>%
  mutate(
    model = map(strap, \(df) lm(tmax ~ tmin + prcp, data = df)),
    glancedata = map(model, \(m) broom::glance(m)),
    tidydata   = map(model, \(m) broom::tidy(m))
  )
boot
rsqdata = model1 |>
  select(.id, glancedata) |>
  unnest(glancedata) |>
  select(.id, r.squared)
rsqdata
betaratio = model1 |>
  select(.id, tidydata) |>
  unnest(tidydata) |>
  group_by(.id) |>
  summarize(
      ratio = { 
      b1 = estimate[term == "tmin"] 
      b2 = estimate[term == "prcp"]   
      b1 / b2               
    }
  )
result = rsqdata |>
  inner_join(betaratio, by = ".id")
result
```
