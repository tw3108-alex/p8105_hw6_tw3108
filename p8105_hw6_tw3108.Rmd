---
title: "p8105_tw3108_hw6"
author: "Tao Wu"
date: "2025-12-03"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,warning=FALSE,message=FALSE}
library(tidyverse)
library(broom)
library(readr)
library(ggplot2)
data <- read_csv("data/homicide-data.csv")
new = data %>% 
  mutate(
   city_state = str_c(city, state, sep = ", "),
   check = if_else(disposition == "Closed by arrest", 1, 0),
   victim_age = as.numeric(victim_age)
  ) %>% 
  filter(!city_state %in% c("Dallas, TX","Phoenix, AZ","Kansas City, MO","Tulsa, AL")
  ) %>% 
  filter(victim_race %in% c("White", "Black"))
baltimore = new %>% 
  filter(city_state == "Baltimore, MD")
model = glm(check ~ victim_age + victim_sex + victim_race, data = baltimore, family = binomial()
 )
tidymodel = broom::tidy(model)
or = tidymodel %>%
  filter(term == "victim_sexMale") %>%
  mutate(
    or = exp(estimate),
    conf.low = exp(estimate - 1.96 * std.error),
    conf.high= exp(estimate + 1.96 * std.error)
  ) %>%
  select(term, or, conf.low, conf.high)
or
cityor = new %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(
    model = map(data, ~ glm( check ~ victim_age + victim_sex + victim_race, data = .x, family = binomial()
  )
  ),
    result = map(model, ~ broom::tidy(.x))
  ) %>% 
  unnest(result) %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(
    or       = exp(estimate),
    conf.low = exp(estimate - 1.96 * std.error),
    conf.high= exp(estimate + 1.96 * std.error)
  ) %>% 
  select(city_state, or, conf.low, conf.high) %>% 
  ungroup()
cityor
cityplot = cityor %>% 
  ggplot(aes(x = or, y = reorder(city_state, or))) +
  geom_point() +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high)) +
  labs(
    x = "or for homocide",
    y = "City & State",
    title = "adjusted or"
  )
cityplot
```

Problem1: 
In most cities, the or is close to 1, indicating that in most cases the clearance rate for male victims is similar to female victims.
A few cities show higher or estimates, but with much wide CI, suggesting that these cities have small sample sizes or limited number of clearances. Overall, there is not enough evidence in most cities to show a significant difference in clearance rates between male and female victims.

```{r, message=FALSE,warning=FALSE}
library(p8105.datasets)
library(tidyverse)
library(modelr)
library(broom)
data("weather_df")
set.seed(1234)
boot = weather_df %>%
  modelr::bootstrap(n = 5000)
  model1 = boot %>%
  mutate(
    model = map(strap, \(df) lm(tmax ~ tmin + prcp, data = df)),
    glancedata = map(model, \(m) broom::glance(m)),
    tidydata   = map(model, \(m) broom::tidy(m))
  )
boot
rsqdata = model1 %>%
  select(.id, glancedata) %>%
  unnest(glancedata) %>%
  select(.id, r.squared)
rsqdata
betaratio = model1 %>%
  select(.id, tidydata) %>%
  unnest(tidydata) %>%
  group_by(.id) %>%
  summarize(
      ratio = { 
      b1 = estimate[term == "tmin"] 
      b2 = estimate[term == "prcp"]   
      b1 / b2               
    }
  )
result = rsqdata %>%
  inner_join(betaratio, by = ".id")
result
rsqplot = result %>%
  ggplot(aes(x = r.squared)) +
  geom_histogram(bins = 30, fill = "blue") +
  labs(
    title = "Bootstrap RÂ²",
    x = expression(R^2),
    y = "Count"
  ) +
  theme_minimal()
rsqplot
betaplot = result %>%
  ggplot(aes(x = ratio)) +
  geom_histogram(bins = 30, fill = "black") +
  labs(
    title = "Bootstrap betaratio",
    x = expression(beta[1] / beta[2]),
    y = "Count"
  ) +
  theme_minimal()
betaplot
bootci = result %>%
  summarize(
    rsqlow   = quantile(r.squared, 0.025),
    rsqhigh  = quantile(r.squared, 0.975),
    ratiolow = quantile(ratio, 0.025),
    ratiohigh= quantile(ratio, 0.975)
  )
bootci
```
```{r,message=FALSE,warning=FALSE}
library(readr)
library(tidyverse)
library(modelr) 
birth <- read_csv("data/birthweight.csv")
glimpse(birth)
birthclean <- birth %>%
  mutate(  babysex = factor(babysex, levels = c(1, 2), labels = c("male", "female")),
           
    mrace = factor(mrace, levels = c(1, 2, 3, 4, 8),labels = c("White", "Black", "Asian", "PuertoRican", "Other")),
    
    frace = factor(frace, levels = c(1, 2, 3, 4, 8, 9), labels = c("White", "Black", "Asian","PuertoRican", "Other", "Unknown")),
    
    malform = factor(malform,levels = c(0, 1), labels = c("absent", "present"))
  )
model <- lm(bwt ~ blength + gaweeks + bhead + babysex + mrace + ppbmi + smoken + wtgain + momage + parity, data = birthclean)
summary(model)
birthres <- birthclean %>%
  add_predictions(model) %>%
  add_residuals(model)
ggplot(birthres, aes(x = pred, y = resid)) +
  geom_point() +
  labs(
    x = "birthweight",
    y = "residuals",
    title = "residuals for model"
  )
model1 <- lm(bwt ~ blength + gaweeks, data = birthclean)
model2 <- lm(bwt ~ bhead + blength + babysex + bhead:blength + bhead:babysex +blength:babysex + bhead:blength:babysex,data = birthclean)
cv_df =
  crossv_mc(birthclean, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test  = map(test, as_tibble)
  )
cv_df =
  cv_df %>%
  mutate( my_model = map(train, \(df) lm(bwt ~ blength + gaweeks + bhead + babysex + mrace + ppbmi + smoken + wtgain + momage + parity,data = df)),
          
    model1 = map(train,\(df) lm(bwt ~ blength + gaweeks, data = df)),
    
    model2 = map(train, \(df) lm(bwt ~ bhead + blength + babysex + bhead:blength + bhead:babysex + blength:babysex + bhead:blength:babysex,data = df) )
  )
cv_df =
  cv_df %>%
  mutate(
    rmse_my = map2_dbl(my_model, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_len  = map2_dbl(model1,   test, \(mod, df) rmse(model = mod, data = df)),
    rmse_bigint  = map2_dbl(model2,   test, \(mod, df) rmse(model = mod, data = df))
  )
cv_df %>% 
  select(starts_with("rmse")) %>%
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
  labs(
    x = "model",
    y = "rmse",
    title = "cv error for models"
  )
```

From the various variables in this dataset,I selected those I believed were most likely to influence bwt. I thought it would be simpler and more intuitive to exclude interaction terms when comparing with the two models below, so I chose the above ten variables for model building. Several of these have relatively direct effects, such as body size, nutrition, or maternal condition; next are gender and smoking, which I think are very likely; and finally, three that I was curious about.
